<div class="prism-title"><h1>친구 목록</h1></div>
<div class="friend-list">


    <%# render partial: "channels/new" %>
    <!-- TODO: 채널 별 삭제 버튼, 사람 옮기기 가능하게-->
    <!-- TODO: 단, '익명피드'와 '나만보기' 채널은 이 리스트에 안나오게!! 글 쓸 때 체크하는 채널 리스트와, 마이페이지에 들어갔을 때 채널 리스트에만 등장해야 함 -->
    <!-- TODO: 그 이유는, 두 채널은 친구들을 분류하는 그룹으로서의 기능이 없을 뿐 아니라, 삭제 또는 수정이 불가하나 채널으로 둘 것이기 때문 -->

    <!-- 전체 친구 -->
    <div id="channel-nav-div">
        <div class="channel-nav all active">전체</div>
        <% @channels.each do |channel| %>
            <div class="channel-nav <%=channel.id%>"><%= channel.name%></div>
        <% end %>
    </div>
    <button id="btn-channel-add">채널 추가</button>
    <%= form_tag '/channels/-1', :id => "name-create-form" do %>
        <%= text_field_tag "name", nil, required: true, :id => "name-create-input" %>
        <%= button_tag "완료", :id => "name-create-btn" %>
    <% end %>

    <div>
        <div id="channel-name-div">
            <h2 id="channel-name">전체</h2>
            <%= form_tag '/channels/-1', :id => "name-edit-form" do %>
                <%= text_field_tag "name", nil, required: true, :value => '전체', :id => "name-edit-input" %>
                <%= button_tag "저장", :id => "name-edit-btn" %>
            <% end %>
        </div>
        <!-- TODO  사람수 표시-->
        <div id="channel-default-btns">
            <button id="btn-channel-name-edit">이름 편집</button>
            <%= link_to '삭제',  '/channels/-1',  method: :delete, data: { confirm: '정말 지울래?!' }, id: "btn-channel-delete" %>
            <button id="btn-channel-edit">채널 편집</button>
        </div>
        <button id="btn-channel-edit-complete">완료</button>
    </div>

    <%= render partial: "friend_list", locals: {friends_with_channels: @friends_with_channels} %>

    <% if @friends_with_channels.empty? %>
        친구를 초대해보세요!<br> <!-- FIXME: 버그인가 왜 줄바꿈이 안되지 -->
        <%= link_to "친구 초대하기", invitation_path %>
    <% end %>
</div>


<script>

    //편집하던거 다 날리기
    function channel_edit_clear() {
        $("#channel-nav-div").removeClass("editing")
        $(".friend-box").removeClass("value-changed")
        $(".btn-friend-channel-edit").hide()
        $("#name-edit-form").hide()
        $("#btn-channel-edit-complete").hide()
        $("#name-create-form").hide()
        $("#channel-default-btns").show()
        $("#btn-channel-add").show()
        $("#channel-name").show()
    }

    function click_channel_nav(element) {
        element.on('click', function(e) {

            if($("#channel-nav-div").hasClass("editing")) {
                channel_edit_clear();
            } 

            $(".channel-nav").removeClass("active")
            $(this).addClass("active")
            $("#channel-name").html($(this).html())
            $(".friend-box").removeClass("disabled");

            if($(this).hasClass("all")) {
                //전체보기
                $("#channel-default-btns").hide()
            }
            else {
                const channelId = $(this).attr('class').split(/\s+/)[1];
                $("#btn-channel-delete").attr('href', `/channels/${channelId}`)
                $("#channel-default-btns").show()

                $(".friend-box").filter(function(index) {
                    return $(this).has('.' + channelId).length ? false : true
                }).addClass("disabled")
            }
        })
    }

    $( document ).ready(function() {

        //채널탭 클릭
        click_channel_nav($(".channel-nav"))

        //인원 편집 시작
        $("#btn-channel-edit").on('click', function(e) {

            //채널 추가하고 있었을 경우
            if($("#channel-nav-div").hasClass("editing")) {
                $("#name-create-form").hide()
                $("#btn-channel-add").show()
            }

            $("#channel-nav-div").addClass("editing")
            $("#channel-default-btns").hide()
            $("#btn-channel-edit-complete").show()

            $(".btn-friend-channel-edit").html('-')
            $(".friend-box-with-edit").find(".disabled").siblings(".btn-friend-channel-edit").html('+')
            $(".btn-friend-channel-edit").show()
        })


        //인원 편집 완료
        $("#btn-channel-edit-complete").on('click', function(e) {
            //TODO friend-box 값들, active한 nav 값 받아서 ajax send
            const channelId = $("#channel-nav-div").find(".active").attr('class').split(/\s+/)[1]
            var friend_ids = []

            //TODO 값 바뀐 friend-box 값들 for문 돌려서 friend id 쌓기
            $(".value-changed").each(function(index, element) {
                friend_ids.push($(element).attr('class').split(/\s+/)[1])
                
                if($(this).hasClass("disabled")) {
                    //delete span
                    $(this).find('.' + channelId).remove()
                } else {
                    //add span
                    $(this).append(`<span class="channel-id ${channelId}"></span>`)
                }
            })

            channel_edit_clear();

            if(friend_ids.length > 0) {
                $.ajax({
                    type: "PUT",
                    url: `/channels/${channelId}/edit_friendship`,
                    data: {"friend_ids": friend_ids},
                    success: function(data) {
                        console.log("successed!")
                    },
                    error: function(data) {
                        console.log("error!")
                    }
                })
            }
        })


        //+ 또는 - 버튼 누름
        $(".btn-friend-channel-edit").on('click', function(e) {
            $(this).siblings(".friend-box").toggleClass("disabled")
            $(this).siblings(".friend-box").toggleClass("value-changed")
            if($(this).html()=='+') {
                $(this).html('-')
            } else {
                $(this).html('+')
            }
        })


        //채널 이름 수정
        $("#btn-channel-name-edit").on('click', function(e) {

            //채널 추가하고 있었을 경우
            if($("#channel-nav-div").hasClass("editing")) {
                $("#name-create-form").hide()
                $("#btn-channel-add").show()
            }

            $("#channel-nav-div").addClass("editing")
            $("#channel-name").hide()
            $("#channel-default-btns").hide()
            $("#name-edit-input").val($("#channel-nav-div").find(".active").html())
            $("#name-edit-form").show()
        })


        //채널 추가
        $("#btn-channel-add").on('click', function(e) {
            //채널 이름 혹은 채널 인원 편집 중이었을 경우
            if($("#channel-nav-div").hasClass("editing")) {
                if($(".value-changed").length > 0) {
                    //값 바뀌었던 것들 제자리로
                    $(".value-changed").toggleClass("disabled")
                }
                channel_edit_clear();
            }

            $("#channel-nav-div").addClass("editing")
            $(this).hide()
            $("#name-create-form").show()
        })

        //채널 이름 수정 완료 or 채널 추가 완료
        $("form").submit( function(e) {
            e.preventDefault();
            
            const channelId = $("#channel-nav-div").find(".active").attr('class').split(/\s+/)[1]
            const form = $(this)
            let method = $(this).is("#name-edit-form") ? "PUT" : "POST"
            let url = $(this).is("#name-edit-form") ? `/channels/${channelId}` : '/channels'
            $.ajax({
                type: method,
                url: url,
                data: form.serialize(),
                success: function(data) {
                    console.log("successed!")
                    
                    form.hide()
                    $("#channel-nav-div").removeClass("editing")
                    if(form.is("#name-edit-form")) {
                        $("#channel-name").html($("#name-edit-input").val())
                        $("#channel-nav-div").find(".active").html($("#name-edit-input").val())
                    } else {
                         $("#channel-name").html($("#name-create-input").val())
                        $(".channel-nav").removeClass("active")
                        var html = $(`<div class="channel-nav ${data.channel_id} active">${$("#name-create-input").val()}</div>`)
                        $("#channel-nav-div").append(html)
                        click_channel_nav(html)
                        $(".friend-box").addClass("disabled")
                    }
                    $("#channel-name").show()
                    $("#channel-default-btns").show()
                    $("#btn-channel-add").show()
                    
                },
                error: function(data) {
                    console.log("error!")
                }
            })
        })


        
    });
</script>