<div class="inner-container">
    <%= render partial: "./user_answers_layout", locals: {user: @user} %>
    <% @drawers.reverse_each do |d| %>
        <% if d.target_type == "Question" %>
            <div class = "prism-box">
                <div class = "prism-box_question">
                    <br>
                    <div>
                        <a href="/questions/<%=d.target.id%>" class="question-content"><%= d.target.content %></a>   
                        <%= link_to image_tag("icons/drawer-on-icon", class: "btn-drawer"), drawer_path(d.target.id, target_type: "Question"), method: :delete, data: {confirm: '이 질문을 서랍장에서 꺼내시겠습니까?'} %>
                    </div>    
                    <div classs = "question-author">    
                        <% if d.target.author.has_role? :newuser %>
                            <br><br>
                            Question made by 
                            <%= render partial: "./user_profile_small", locals: {user: d.target.author} %>
                        <% end %>
                    </div>
                </div>
                <br>
            </div>
            
        <% else %>
            <div class = "prism-box">
                <div class = "prism-box__header">
                    <%= render partial: "./user_profile", locals: {user: d.target.author} %><br/>
                </div>
                <div class = "prism-box__content">
                    <br> 
                    <a href="/questions/<%=d.target.question.id%>/friend" class="question"><%= d.target.question.content %></a> <br>
                    <div class = "answer">
                        <%= d.target.content %>
                        <%= link_to "전체 글 보기", answer_path(d.target.id) %><br/>
                    </div>
                    <br>
                    <div class = "date"><%= time_tag d.target.updated_at, class: "timeago" %></div>
                </div>
                <div class = "prism-box__footer" style="padding-bottom: 10px;">
                    <% if current_user.id == @user.id %>
                        <%= link_to "수정", edit_answer_path(d.target.id) %>
                        <%= link_to "삭제", answer_path(d.target.id),
                                            method: :delete,
                                            data: { confirm: '답변을 지우시겠습니까?'} %>
                <% end %>                 

                <%= render 'answers/drawer', a: d.target, target_type: "Answer" %>
                </div>
            </div>
        <% end %>
    <% end %>
</div>

<%= render 'layouts/timestamp' %>
<script>
    $(document).ready(function() {
        $(".btn-drawer").on('click', function(e) {

            var drawer = $(this)

            var method = (drawer.hasClass("do-drawer")) ? "POST" : "DELETE"

            if(drawer.hasClass("do-drawer")) {
                method = "POST"
            }
            else {
                if(confirm("이 글을 서랍장에서 꺼내시겠습니까?")) {
                    method = "DELETE"
                }
                else {
                    return;
                }
            }


            $.ajax({
                type: method,
                url: drawer.attr("data-url"),
                success: function(data) {
                    const src = drawer.attr('src')
                    const url = drawer.attr('data-url')
                    const changed_src = drawer.attr('data-changed-src')
                    const changed_url = drawer.attr('data-changed-url')
                    drawer.attr('src', changed_src)
                    drawer.attr('data-url', changed_url)
                    drawer.attr('data-changed-src', src)
                    drawer.attr('data-changed-url', url)
                    drawer.toggleClass("do-drawer")
                    drawer.parent().parent().remove()
                },
                error: function(data) {
                    console.log("error!")
                }
            })
        })
    })
</script>